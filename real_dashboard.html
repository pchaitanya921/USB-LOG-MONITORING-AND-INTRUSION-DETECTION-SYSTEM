<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USB Monitoring System - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="advanced_styles.css">
    <link rel="stylesheet" href="scan_animations.css">
    <link rel="stylesheet" href="usb-detection-styles.css">
    <style>
        /* Dashboard specific styles */
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color);
        }

        .refresh-btn {
            background-color: var(--primary-color);
            color: var(--terminal-bg);
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .refresh-btn:hover {
            background-color: var(--accent-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .section-header {
            background-color: var(--card-header-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-content {
            padding: 20px;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--primary-color);
        }

        .loading-spinner i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .device-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .device-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--card-border);
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--primary-color);
        }

        .device-details {
            flex: 1;
        }

        .device-name {
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .device-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-family: var(--font-mono);
        }

        .device-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-readonly {
            background-color: rgba(56, 189, 248, 0.2);
            color: #38bdf8;
        }

        .status-fullaccess {
            background-color: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-blocked {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .alert-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .alert-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--card-border);
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .alert-details {
            flex: 1;
        }

        .alert-message {
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .alert-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .alert-severity {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .severity-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .severity-medium {
            background-color: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .severity-low {
            background-color: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .empty-state-message {
            max-width: 400px;
        }

        /* Device Management Styles */
        .section-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background-color: transparent;
            border: 1px solid var(--card-border);
            border-radius: 4px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .primary-btn {
            background-color: rgba(0, 255, 0, 0.1);
            color: var(--primary-color);
            border-color: rgba(0, 255, 0, 0.3);
        }

        .primary-btn:hover {
            background-color: rgba(0, 255, 0, 0.2);
        }

        .secondary-btn {
            background-color: rgba(56, 189, 248, 0.1);
            color: #38bdf8;
            border-color: rgba(56, 189, 248, 0.3);
        }

        .secondary-btn:hover {
            background-color: rgba(56, 189, 248, 0.2);
        }

        .device-permissions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .permission-card {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s;
        }

        .permission-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.1);
        }

        .permission-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .permission-icon.read-only {
            background-color: rgba(56, 189, 248, 0.1);
            color: #38bdf8;
            border: 1px solid rgba(56, 189, 248, 0.3);
        }

        .permission-icon.full-access {
            background-color: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .permission-icon.blocked {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .permission-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .permission-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
            flex-grow: 1;
        }

        .permission-btn {
            background-color: transparent;
            border: 1px solid var(--card-border);
            border-radius: 4px;
            padding: 8px 16px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .permission-btn:hover {
            background-color: rgba(0, 255, 0, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Enhanced device list */
        .device-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .device-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--card-border);
            position: relative;
            transition: all 0.2s;
        }

        .device-item:hover {
            background-color: rgba(0, 255, 0, 0.05);
        }

        .device-item.blocked-device {
            background-color: rgba(239, 68, 68, 0.05);
            border-left: 3px solid #ef4444;
        }

        .device-item.blocked-device .device-icon {
            color: #ef4444;
        }

        .danger-btn {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .danger-btn:hover {
            background-color: rgba(239, 68, 68, 0.2);
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
            margin-right: 15px;
        }

        .device-action-btn {
            background-color: transparent;
            border: 1px solid var(--card-border);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scan-btn {
            background-color: rgba(0, 255, 0, 0.1);
            color: var(--primary-color);
            border-color: rgba(0, 255, 0, 0.3);
        }

        .scan-btn:hover {
            background-color: rgba(0, 255, 0, 0.2);
        }

        .change-btn {
            background-color: rgba(56, 189, 248, 0.1);
            color: #38bdf8;
            border-color: rgba(56, 189, 248, 0.3);
        }

        .change-btn:hover {
            background-color: rgba(56, 189, 248, 0.2);
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 300px;
            max-width: 400px;
            animation: slide-in 0.3s ease-out forwards;
        }

        .notification.fade-out {
            animation: slide-out 0.5s ease-out forwards;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
        }

        .notification.success {
            border-left: 4px solid #22c55e;
        }

        .notification.success i {
            color: #22c55e;
        }

        .notification.info {
            border-left: 4px solid #38bdf8;
        }

        .notification.info i {
            color: #38bdf8;
        }

        .notification.warning {
            border-left: 4px solid #f59e0b;
        }

        .notification.warning i {
            color: #f59e0b;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        .notification.error i {
            color: #ef4444;
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slide-out {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Background Animation Container -->
    <div class="background-animation"></div>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-shield-alt"></i> USB Monitoring System
        </div>
        <div class="navbar-links">
            <a href="real_dashboard.html" class="active"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a href="devices.html"><i class="fas fa-usb"></i> Devices</a>
            <a href="scans.html"><i class="fas fa-search"></i> Scans</a>
            <a href="alerts.html"><i class="fas fa-exclamation-triangle"></i> Alerts</a>
            <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="dashboard-title">
                <i class="fas fa-shield-alt"></i>
                <h1>USB Monitoring System</h1>
            </div>
            <button type="button" id="refresh-data" class="refresh-btn">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Connected Devices</div>
                <div class="stat-value" id="connected-devices-count">0</div>
                <div>Active USB connections</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Devices</div>
                <div class="stat-value" id="total-devices-count">0</div>
                <div>All USB devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Scans</div>
                <div class="stat-value" id="total-scans-count">0</div>
                <div>Completed scans</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Detected Threats</div>
                <div class="stat-value" id="detected-threats-count">0</div>
                <div>Malicious files found</div>
            </div>
        </div>

        <!-- Connected USB Devices Section -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-usb"></i> Connected USB Devices
                </h2>
                <div class="section-actions">
                    <button type="button" id="scan-all-btn" class="action-btn primary-btn">
                        <i class="fas fa-search"></i> Scan All
                    </button>
                    <button type="button" id="refresh-devices-btn" class="action-btn secondary-btn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="section-content" id="connected-devices-container">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-2x"></i>
                    <span>Loading USB devices...</span>
                </div>
            </div>
        </div>

        <!-- Device Management Section -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-cogs"></i> Device Management
                </h2>
            </div>
            <div class="section-content" id="device-management-container">
                <div class="device-permissions-grid">
                    <div class="permission-card">
                        <div class="permission-icon read-only">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="permission-title">Read Only</div>
                        <div class="permission-description">Allow devices to be read but not written to</div>
                        <button type="button" id="set-readonly-btn" class="permission-btn">Set as Default</button>
                    </div>

                    <div class="permission-card">
                        <div class="permission-icon full-access">
                            <i class="fas fa-lock-open"></i>
                        </div>
                        <div class="permission-title">Full Access</div>
                        <div class="permission-description">Allow full read and write access to devices</div>
                        <button type="button" id="set-fullaccess-btn" class="permission-btn">Set as Default</button>
                    </div>

                    <div class="permission-card">
                        <div class="permission-icon blocked">
                            <i class="fas fa-ban"></i>
                        </div>
                        <div class="permission-title">Block All</div>
                        <div class="permission-description">Block all access to devices</div>
                        <button type="button" id="block-all-devices-btn" class="permission-btn danger-btn">Block Connected Devices</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- USB Connection Events Section -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-plug"></i> USB Connection Events
                </h2>
            </div>
            <div class="section-content">
                <div id="usb-events-container" class="usb-events-container">
                    <div class="empty-state">
                        <i class="fas fa-plug"></i>
                        <div class="empty-state-title">No USB Events</div>
                        <div class="empty-state-message">
                            USB connection events will appear here when devices are connected or disconnected.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Scans Section -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-search"></i> Active Scans
                </h2>
            </div>
            <div class="section-content">
                <div id="scan-progress-container">
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <div class="empty-state-title">No Active Scans</div>
                        <div class="empty-state-message">
                            Active scans will appear here when USB devices are being scanned.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scan Results Section -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-check"></i> Recent Scan Results
                </h2>
            </div>
            <div class="section-content">
                <div id="scan-results-container">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <div class="empty-state-title">No Scan Results</div>
                        <div class="empty-state-message">
                            Scan results will appear here after USB devices are scanned.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Alerts Section -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i> Recent Alerts
                </h2>
            </div>
            <div class="section-content" id="recent-alerts-container">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-2x"></i>
                    <span>Loading alerts...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="advanced_animations.js"></script>
    <script src="network_animation.js"></script>
    <script src="real-usb-detection.js"></script>
    <script>
        // API endpoint
        const API_URL = 'http://localhost:5000/api';

        // DOM elements
        const connectedDevicesCount = document.getElementById('connected-devices-count');
        const totalDevicesCount = document.getElementById('total-devices-count');
        const totalScansCount = document.getElementById('total-scans-count');
        const detectedThreatsCount = document.getElementById('detected-threats-count');
        const connectedDevicesContainer = document.getElementById('connected-devices-container');
        const recentAlertsContainer = document.getElementById('recent-alerts-container');
        const refreshButton = document.getElementById('refresh-data');

        // Helper function to format device status
        function getStatusClass(permission) {
            switch(permission) {
                case 'read_only':
                    return 'status-readonly';
                case 'full_access':
                    return 'status-fullaccess';
                case 'blocked':
                    return 'status-blocked';
                default:
                    return 'status-readonly';
            }
        }

        function getStatusText(permission) {
            switch(permission) {
                case 'read_only':
                    return 'Read Only';
                case 'full_access':
                    return 'Full Access';
                case 'blocked':
                    return 'Blocked';
                default:
                    return 'Read Only';
            }
        }

        // Fetch data from API
        async function fetchData() {
            try {
                // Show loading state
                connectedDevicesContainer.innerHTML = `
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-2x"></i>
                        <span>Loading USB devices...</span>
                    </div>
                `;

                recentAlertsContainer.innerHTML = `
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-2x"></i>
                        <span>Loading alerts...</span>
                    </div>
                `;

                // Fetch devices using the scan endpoint
                console.log("Fetching data from API...");
                const scanResponse = await fetch(`${API_URL}/scan`);
                const scanData = await scanResponse.json();

                console.log("API Response:", scanData);

                // Get history from the scan response or fetch it separately
                let history = scanData.history || [];

                // If history is not in the scan response, fetch it separately
                if (!scanData.history) {
                    console.log("History not found in scan response, fetching separately...");
                    const historyResponse = await fetch(`${API_URL}/history`);
                    history = await historyResponse.json();
                }

                // For scan results, we'll use the history data for now
                // In a real app, this would be a separate endpoint
                const scanResults = history.filter(event => event.event_type === 'scan') || [];

                console.log("Devices:", scanData.devices);
                console.log("History:", history);
                console.log("Scan Results:", scanResults);

                // Update UI
                updateStats(scanData, scanResults);
                updateDevices(scanData.devices || []);
                updateAlerts(history, scanResults);

                // Show notification if devices are found
                if (scanData.devices && scanData.devices.length > 0) {
                    showNotification(`Found ${scanData.devices.length} USB device(s)`, 'success');
                }

            } catch (error) {
                console.error('Error fetching data:', error);

                // Show error message
                connectedDevicesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Connection Error</div>
                        <div class="empty-state-message">
                            Could not connect to the USB monitoring server. Make sure the server is running.
                        </div>
                    </div>
                `;

                recentAlertsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Connection Error</div>
                        <div class="empty-state-message">
                            Could not connect to the USB monitoring server. Make sure the server is running.
                        </div>
                    </div>
                `;
            }
        }

        // Update statistics
        function updateStats(scanData, scanResults) {
            console.log("Updating stats with:", { scanData, scanResults });

            // Count connected devices
            const connected = scanData.devices ? scanData.devices.length : 0;
            console.log("Connected devices:", connected);
            connectedDevicesCount.textContent = connected;

            // Count total devices (from history)
            const uniqueDevices = new Set();
            if (scanData.history && Array.isArray(scanData.history)) {
                scanData.history.forEach(item => {
                    if (item.event_type === 'connected') {
                        uniqueDevices.add(item.device_id);
                    }
                });
            }
            totalDevicesCount.textContent = uniqueDevices.size || connected;

            // Count total scans
            totalScansCount.textContent = scanData.scan_count || scanResults.length || 0;

            // Count detected threats
            let threatCount = 0;
            if (Array.isArray(scanResults)) {
                scanResults.forEach(scan => {
                    if (scan.result && scan.result.malicious_files) {
                        threatCount += scan.result.malicious_files.length;
                    }
                    if (scan.result && scan.result.suspicious_files) {
                        threatCount += scan.result.suspicious_files.length;
                    }
                });
            }
            detectedThreatsCount.textContent = threatCount;
        }

        // Update devices list
        function updateDevices(devices) {
            console.log("Updating devices with:", devices);

            if (!devices || devices.length === 0) {
                console.log("No devices found");
                connectedDevicesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-usb"></i>
                        <div class="empty-state-title">No USB Found</div>
                        <div class="empty-state-message">
                            Connect a USB device to your computer to see it here.
                        </div>
                    </div>
                `;
                return;
            }

            let devicesList = '<ul class="device-list">';

            devices.forEach(device => {
                // Handle different property names from different API implementations
                const deviceName = device.name || device.product_name || 'Unknown Device';
                const deviceId = device.id || device.device_id || 'Unknown ID';
                const driveLetter = device.drive_letter || device.mount_point || 'N/A';
                const size = device.size || device.capacity || 'Unknown';
                const freeSpace = device.free_space || 'Unknown';
                const permission = device.permission || device.status || 'read_only';
                const connectionTime = device.connection_time || device.last_connected || 'Unknown';

                // Determine if device is blocked
                const isBlocked = permission === 'blocked';
                const deviceClass = isBlocked ? 'device-item blocked-device' : 'device-item';

                // Determine status text and class
                const statusClass = getStatusClass(permission);
                const statusText = getStatusText(permission);

                devicesList += `
                    <li class="${deviceClass}" data-device-id="${deviceId}" data-permission="${permission}">
                        <div class="device-icon">
                            <i class="fas fa-usb fa-2x"></i>
                        </div>
                        <div class="device-details">
                            <div class="device-name">${deviceName}</div>
                            <div class="device-info">ID: ${deviceId.substring(0, 20)}${deviceId.length > 20 ? '...' : ''}</div>
                            <div class="device-info">Drive: ${driveLetter} | ${size ? 'Size: ' + size : ''} ${freeSpace ? '| Free: ' + freeSpace : ''}</div>
                            <div class="device-info">Connected: ${connectionTime}</div>
                            <div class="device-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="device-actions">
                            <button type="button" class="device-action-btn scan-btn" data-device-id="${deviceId}">
                                <i class="fas fa-search"></i> Scan
                            </button>
                            <button type="button" class="device-action-btn ${isBlocked ? 'change-btn' : 'block-btn'}" data-device-id="${deviceId}">
                                <i class="fas ${isBlocked ? 'fa-unlock' : 'fa-ban'}"></i> ${isBlocked ? 'Unblock' : 'Block'}
                            </button>
                        </div>
                    </li>
                `;
            });

            devicesList += '</ul>';
            connectedDevicesContainer.innerHTML = devicesList;

            // Add event listeners to device action buttons
            document.querySelectorAll('.scan-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const deviceId = btn.getAttribute('data-device-id');
                    scanDevice(deviceId);
                });
            });

            document.querySelectorAll('.block-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const deviceId = btn.getAttribute('data-device-id');
                    blockDevice(deviceId);
                });
            });

            // Add click event to device items for details
            document.querySelectorAll('.device-item').forEach(item => {
                item.addEventListener('click', () => {
                    const deviceId = item.getAttribute('data-device-id');
                    showDeviceDetails(deviceId);
                });
            });
        }

        // Scan a specific device
        function scanDevice(deviceId) {
            // Find the device in the list
            const deviceItem = document.querySelector(`.device-item[data-device-id="${deviceId}"]`);
            if (!deviceItem) return;

            // Show scanning animation
            const scanBtn = deviceItem.querySelector('.scan-btn');
            const originalText = scanBtn.innerHTML;
            scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
            scanBtn.disabled = true;

            // Simulate scanning (in a real app, this would be an API call)
            setTimeout(() => {
                // Reset button
                scanBtn.innerHTML = originalText;
                scanBtn.disabled = false;

                // Show success message
                showNotification('Scan completed successfully', 'success');
            }, 2000);
        }

        // Block a specific device
        function blockDevice(deviceId) {
            // Find the device in the list
            const deviceItem = document.querySelector(`.device-item[data-device-id="${deviceId}"]`);
            if (!deviceItem) return;

            // Check if device is already blocked
            const isBlocked = deviceItem.getAttribute('data-permission') === 'blocked';

            // Get the button (could be block-btn or change-btn)
            const blockBtn = deviceItem.querySelector('.block-btn') || deviceItem.querySelector('.change-btn');
            if (!blockBtn) return;

            const originalText = blockBtn.innerHTML;
            blockBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${isBlocked ? 'Unblocking...' : 'Blocking...'}`;
            blockBtn.disabled = true;

            // Make API call to set device permission
            fetch(`${API_URL}/set-permission`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    device_id: deviceId,
                    permission: isBlocked ? 'read_only' : 'blocked'
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Reset button
                blockBtn.disabled = false;

                if (data.success) {
                    if (isBlocked) {
                        // Unblock the device
                        deviceItem.classList.remove('blocked-device');
                        deviceItem.setAttribute('data-permission', 'read_only');

                        // Update button
                        blockBtn.innerHTML = '<i class="fas fa-ban"></i> Block';
                        blockBtn.classList.remove('change-btn');
                        blockBtn.classList.add('block-btn');

                        // Update status display
                        const statusElement = deviceItem.querySelector('.device-status');
                        if (statusElement) {
                            statusElement.className = 'device-status status-readonly';
                            statusElement.textContent = 'Read Only';
                        }

                        showNotification(`Device unblocked successfully`, 'success');
                    } else {
                        // Block the device
                        deviceItem.classList.add('blocked-device');
                        deviceItem.setAttribute('data-permission', 'blocked');

                        // Update button
                        blockBtn.innerHTML = '<i class="fas fa-unlock"></i> Unblock';
                        blockBtn.classList.remove('block-btn');
                        blockBtn.classList.add('change-btn');

                        // Update status display
                        const statusElement = deviceItem.querySelector('.device-status');
                        if (statusElement) {
                            statusElement.className = 'device-status status-blocked';
                            statusElement.textContent = 'Blocked';
                        }

                        showNotification(`Device blocked successfully`, 'success');
                    }
                } else {
                    // Show error message
                    blockBtn.innerHTML = originalText;
                    showNotification(data.message || 'Failed to update device. Please try again.', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating device:', error);

                // Reset button
                blockBtn.innerHTML = originalText;
                blockBtn.disabled = false;

                // Show error message
                showNotification('Failed to update device. Please try again.', 'error');
            });

            /*
            // This is how you would implement a real API call
            fetch(`${API_URL}/block-device`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    device_id: deviceId,
                    action: isBlocked ? 'unblock' : 'block'
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Reset button
                blockBtn.disabled = false;

                if (data.success) {
                    if (isBlocked) {
                        // Unblock the device
                        deviceItem.classList.remove('blocked-device');
                        deviceItem.setAttribute('data-permission', 'read_only');

                        // Update button
                        blockBtn.innerHTML = '<i class="fas fa-ban"></i> Block';
                        blockBtn.classList.remove('change-btn');
                        blockBtn.classList.add('block-btn');

                        showNotification(`Device unblocked successfully`, 'success');
                    } else {
                        // Block the device
                        deviceItem.classList.add('blocked-device');
                        deviceItem.setAttribute('data-permission', 'blocked');

                        // Update button
                        blockBtn.innerHTML = '<i class="fas fa-unlock"></i> Unblock';
                        blockBtn.classList.remove('block-btn');
                        blockBtn.classList.add('change-btn');

                        showNotification(`Device blocked successfully`, 'success');
                    }
                } else {
                    // Show error message
                    blockBtn.innerHTML = originalText;
                    showNotification(data.message || 'Failed to update device. Please try again.', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating device:', error);

                // Reset button
                blockBtn.innerHTML = originalText;
                blockBtn.disabled = false;

                // Show error message
                showNotification('Failed to update device. Please try again.', 'error');
            });
            */
        }

        // Block all connected devices
        function blockAllDevices() {
            // Get all device IDs
            const deviceItems = document.querySelectorAll('.device-item');
            if (deviceItems.length === 0) {
                showNotification('No devices connected to block', 'info');
                return;
            }

            // Show notification
            showNotification(`Blocking ${deviceItems.length} connected devices...`, 'info');

            // Block each device
            let blockedCount = 0;
            let totalToBlock = 0;

            // Count devices that need to be blocked
            deviceItems.forEach(item => {
                const isAlreadyBlocked = item.getAttribute('data-permission') === 'blocked';
                if (!isAlreadyBlocked) {
                    totalToBlock++;
                }
            });

            if (totalToBlock === 0) {
                showNotification('All devices are already blocked', 'info');
                return;
            }

            deviceItems.forEach(item => {
                const deviceId = item.getAttribute('data-device-id');
                const isAlreadyBlocked = item.getAttribute('data-permission') === 'blocked';

                // Skip already blocked devices
                if (isAlreadyBlocked) {
                    blockedCount++;
                    checkCompletion();
                    return;
                }

                // Make API call to block the device
                fetch(`${API_URL}/set-permission`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        device_id: deviceId,
                        permission: 'blocked'
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    blockedCount++;

                    if (data.success) {
                        // Update UI to show device is blocked
                        item.classList.add('blocked-device');
                        item.setAttribute('data-permission', 'blocked');

                        // Update button if it exists
                        const blockBtn = item.querySelector('.block-btn');
                        if (blockBtn) {
                            blockBtn.innerHTML = '<i class="fas fa-unlock"></i> Unblock';
                            blockBtn.classList.remove('block-btn');
                            blockBtn.classList.add('change-btn');
                        }

                        // Update status display
                        const statusElement = item.querySelector('.device-status');
                        if (statusElement) {
                            statusElement.className = 'device-status status-blocked';
                            statusElement.textContent = 'Blocked';
                        }
                    }

                    checkCompletion();
                })
                .catch(error => {
                    console.error('Error blocking device:', error);
                    blockedCount++;
                    checkCompletion();
                });
            });

            function checkCompletion() {
                // Show success message when all devices are processed
                if (blockedCount === deviceItems.length) {
                    showNotification(`All devices blocked successfully`, 'success');
                }
            }

            /*
            // This is how you would implement a real API call
            deviceItems.forEach(item => {
                const deviceId = item.getAttribute('data-device-id');
                const isAlreadyBlocked = item.getAttribute('data-permission') === 'blocked';

                // Skip already blocked devices
                if (isAlreadyBlocked) {
                    blockedCount++;
                    checkCompletion();
                    return;
                }

                // Make API call to block the device
                fetch(`${API_URL}/block-device`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ device_id: deviceId }),
                })
                .then(response => response.json())
                .then(data => {
                    blockedCount++;

                    // Update UI to show device is blocked
                    item.classList.add('blocked-device');
                    item.setAttribute('data-permission', 'blocked');

                    // Update button if it exists
                    const blockBtn = item.querySelector('.block-btn');
                    if (blockBtn) {
                        blockBtn.innerHTML = '<i class="fas fa-unlock"></i> Unblock';
                        blockBtn.classList.remove('block-btn');
                        blockBtn.classList.add('change-btn');
                    }

                    checkCompletion();
                })
                .catch(error => {
                    console.error('Error blocking device:', error);
                    blockedCount++;
                    checkCompletion();
                });
            });

            function checkCompletion() {
                // Show success message when all devices are blocked
                if (blockedCount === deviceItems.length) {
                    showNotification(`All devices blocked successfully`, 'success');
                }
            }
            */
        }

        // Show device details
        function showDeviceDetails(deviceId) {
            // In a real app, this would show a modal with device details
            // For now, we'll just show a notification
            showNotification('Device details feature coming soon', 'info');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button type="button" class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;

            document.body.appendChild(notification);

            // Add close button event
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
            });

            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        // Update alerts list
        function updateAlerts(history, scanResults) {
            // Combine connection events and scan results
            const alerts = [];

            // Add connection events from history
            if (Array.isArray(history)) {
                history.forEach(event => {
                    if (event.event_type === 'connected') {
                        alerts.push({
                            type: 'connection',
                            message: `USB device connected: ${event.device_name}`,
                            timestamp: event.timestamp,
                            severity: 'low'
                        });
                    } else if (event.event_type === 'disconnected') {
                        alerts.push({
                            type: 'disconnection',
                            message: `USB device disconnected: ${event.device_name}`,
                            timestamp: event.timestamp,
                            severity: 'low'
                        });
                    }
                });
            }

            // Add scan results with threats
            if (Array.isArray(scanResults)) {
                scanResults.forEach(scan => {
                    if (scan.result) {
                        const maliciousCount = scan.result.malicious_files ? scan.result.malicious_files.length : 0;
                        const suspiciousCount = scan.result.suspicious_files ? scan.result.suspicious_files.length : 0;

                        if (maliciousCount > 0) {
                            alerts.push({
                                type: 'threat',
                                message: `Detected ${maliciousCount} malicious files on ${scan.drive_path || 'USB device'}`,
                                timestamp: scan.timestamp,
                                severity: 'high'
                            });
                        } else if (suspiciousCount > 0) {
                            alerts.push({
                                type: 'threat',
                                message: `Detected ${suspiciousCount} suspicious files on ${scan.drive_path || 'USB device'}`,
                                timestamp: scan.timestamp,
                                severity: 'medium'
                            });
                        } else if (scan.result.status === 'completed') {
                            alerts.push({
                                type: 'scan',
                                message: `Scan completed on ${scan.drive_path || 'USB device'}: No threats found`,
                                timestamp: scan.timestamp,
                                severity: 'low'
                            });
                        }
                    }
                });
            }

            // Sort by timestamp (newest first)
            if (alerts.length > 0) {
                alerts.sort((a, b) => {
                    try {
                        const dateA = new Date(a.timestamp.replace(',', ''));
                        const dateB = new Date(b.timestamp.replace(',', ''));
                        return dateB - dateA;
                    } catch (e) {
                        return 0; // If date parsing fails, don't change order
                    }
                });
            }

            // Display alerts
            if (alerts.length === 0) {
                recentAlertsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <div class="empty-state-title">No Recent Alerts</div>
                        <div class="empty-state-message">
                            Alerts will appear here when USB devices are connected or scanned.
                        </div>
                    </div>
                `;
                return;
            }

            // Take only the 5 most recent alerts
            const recentAlerts = alerts.slice(0, 5);

            let alertsList = '<ul class="alert-list">';

            recentAlerts.forEach(alert => {
                let icon = '';
                let severityClass = '';

                // Set icon based on alert type
                switch(alert.type) {
                    case 'connection':
                        icon = '<i class="fas fa-plug fa-2x" style="color: #22c55e;"></i>';
                        break;
                    case 'disconnection':
                        icon = '<i class="fas fa-unlink fa-2x" style="color: #f59e0b;"></i>';
                        break;
                    case 'threat':
                        icon = '<i class="fas fa-virus fa-2x" style="color: #ef4444;"></i>';
                        break;
                    case 'scan':
                        icon = '<i class="fas fa-search fa-2x" style="color: #38bdf8;"></i>';
                        break;
                    default:
                        icon = '<i class="fas fa-info-circle fa-2x" style="color: #38bdf8;"></i>';
                }

                // Set severity class
                switch(alert.severity) {
                    case 'high':
                        severityClass = 'severity-high';
                        break;
                    case 'medium':
                        severityClass = 'severity-medium';
                        break;
                    case 'low':
                        severityClass = 'severity-low';
                        break;
                    default:
                        severityClass = 'severity-low';
                }

                alertsList += `
                    <li class="alert-item">
                        <div class="alert-icon">
                            ${icon}
                        </div>
                        <div class="alert-details">
                            <div class="alert-message">${alert.message}</div>
                            <div class="alert-time">${alert.timestamp}</div>
                        </div>
                        <div class="alert-severity ${severityClass}">
                            ${alert.severity}
                        </div>
                    </li>
                `;
            });

            alertsList += '</ul>';
            recentAlertsContainer.innerHTML = alertsList;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initial data fetch
            fetchData();

            // Refresh button click
            refreshButton.addEventListener('click', fetchData);

            // Scan all devices button
            document.getElementById('scan-all-btn').addEventListener('click', () => {
                // Show notification
                showNotification('Scanning all connected devices...', 'info');

                // Simulate scanning
                setTimeout(() => {
                    showNotification('All devices scanned successfully', 'success');
                }, 3000);
            });

            // Refresh devices button
            document.getElementById('refresh-devices-btn').addEventListener('click', fetchData);

            // Permission buttons
            document.getElementById('set-readonly-btn').addEventListener('click', () => {
                showNotification('Default permission set to Read Only', 'success');
            });

            document.getElementById('set-fullaccess-btn').addEventListener('click', () => {
                showNotification('Default permission set to Full Access', 'success');
            });

            document.getElementById('block-all-devices-btn').addEventListener('click', () => {
                blockAllDevices();
            });

            // Auto-refresh every 10 seconds
            setInterval(fetchData, 10000);
        });
    </script>
</body>
</html>
